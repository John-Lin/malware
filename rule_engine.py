import re
import os
import logging
import time
from malware import utils
from malware.snort import SnortRule
from malware import pickle_tool
from malware import virustotal

logger = logging.getLogger(__name__)

request_times = 0
init_timer = time.time()


def list_pcap(path):
    for dirPath, dirNames, fileNames in os.walk(path):
        for f in fileNames:
            if f.split('.')[1] == 'pcap':
                yield os.path.join(dirPath, f)


def get_positive(resource, cache={}):
    if resource in cache.keys():
        logger.debug("%s in cache" % resource)
        positives = cache.get(resource)
        # logger.info('%s in cache positives: %s' % (resource, positives))
        return positives
    else:
        global request_times
        global init_timer
        if request_times == 300:
            request_times = 0
            period = time.time() - init_timer
            waiting = 60 - period + 1
            if waiting > 0:
                logger.info("Waiting %s seconds", (str(waiting)))
                time.sleep(waiting)
            init_timer = time.time()

        logger.info("Search on VirusTotal counter: %s", str(request_times))
        request_times += 1
        positives = virustotal.url_report(resource)

        if positives >= 0:
            cache[resource] = positives
            return positives
        elif positives is None:
            logger.info("No report. Submmit the URL to VirusTotal")
            request_times += 1
            virustotal.submit_url(resource)
            return None
        else:
            logger.debug("Get reports failed.")
            return None


def iterpayload(path):
    connection = utils.follow_tcp_stream(path)
    for conn, frame in connection.iteritems():
        for seq, content in frame.iteritems():
            if content:
                # Generate the content and 5-tuple
                yield content, conn
            else:
                # Some packets have no payload
                pass


def gen_rule(pcap_path):
    # rule_set = list()
    cache = pickle_tool.check_json()
    # sid = 1000000
    for content, conn in iterpayload('%s' % (pcap_path)):
        # print content, utils.connection_key_2_str(conn)
        get_method = re.search('GET (.*) ', content)
        host = re.search('Host: (.*)', content)
        if host and get_method:
            # pos = get_positive(host.group(1).rstrip(), cache)
            # print host.group(1).rstrip()

            # if pos > 0:
            #     sid += 1
            #     rule = make_host_rule(host.group(0).rstrip(), conn[3])
            #     if not iscontent(rule, RULE):
            #        RULE.append(rule)
                # else:
                #     pass
                    # sid -= 1
            # else:
            #     pass
                # print "NOT generate"
                # NOT generate rule

            if get_method.group(1) == '/':
                url = host.group(1).rstrip()
            else:
                url = host.group(1).rstrip() + get_method.group(1)

            host_content = host.group(0).rstrip()
            uricontent = get_method.group(1)
            pos = get_positive(url, cache)
            if pos > 0:
                # print "BAD URL: %s" % uricontent
                # sid += 1
                if uricontent == '/':
                    uricontent = None
                rule = make_uri_rule(host_content, uricontent, conn[3])
                yield rule
                # if not isuricontent(rule, RULE):
                #    RULE.append(rule)
                # else:
                #    sid -= 1
            else:
                # positives == 0 or positives == None
                pass

        else:
            # print "no URL"
            pass
            # print repr(content)
    # for r in rule_set:
    #     print r
    pickle_tool.update_json(cache)
    # return rule_set


def make_host_rule(content, dst_port, sid=0):
    rule = SnortRule()
    pattern = dict()
    pattern['msg'] = '"Trojan.Gen"'
    pattern['content'] = ['"{host}"'.format(host=content), 'nocase']
    # pattern['sid'] = sid
    pattern['dst_port'] = dst_port
    rule.set_malicious_pattern(**pattern)
    return rule


def make_uri_rule(content, uricontent, dst_port, sid=0):
    rule = SnortRule()
    pattern = dict()
    pattern['msg'] = '"Trojan.Gen.uricontent"'
    pattern['content'] = ['"{host}"'.format(host=content), 'nocase']
    pattern['uricontent'] = ['"{uri}"'.format(uri=uricontent), 'nocase']
    # pattern['sid'] = sid
    pattern['dst_port'] = dst_port
    rule.set_malicious_pattern(**pattern)
    return rule


def main():
    logging.basicConfig(level=logging.INFO,
                        format='[%(levelname)s] %(message)s',)

    rule_instances = list()
    RULE = list()

    for pcap in list_pcap('./PCAPLog/'):
        for rule in gen_rule(pcap):
            rule_instances.append(rule)

    for ruleobj in rule_instances:
        RULE.append(str(ruleobj))

    RULE = list(set(RULE))

    for r in RULE:
        print r


if __name__ == "__main__":
    main()
