import simplejson
import urllib
import urllib2
import apikey
import logging
import pickle_tool
import time

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)


def scan_url(resource):
    '''Sent a URLs sacn request to virustotal'''
    logger.debug('%s Checking virustotal' % resource)
    url = "https://www.virustotal.com/vtapi/v2/url/report"
    parameters = {"resource": resource, "apikey": apikey.APIKEY_0}
    data = urllib.urlencode(parameters)
    req = urllib2.Request(url, data)
    response = urllib2.urlopen(req)
    json = response.read()
    if json:
        response_dict = simplejson.loads(json)
        return response_dict.get('positives')
    else:
        return -1


def update_local_cache():
    '''Self update the exist URLs in pickle'''
    cache = pickle_tool.check_pickle()
    for resource in cache.keys():
        positives = scan_url(resource)
        if positives >= 0:
            logger.debug('Now scan %s' % resource)
            cache[resource] = positives
            time.sleep(1)
        else:
            logger.info('%s Scan Faild wait 60 sec' % resource)
            time.sleep(60)

    pickle_tool.update_pickle(cache)
